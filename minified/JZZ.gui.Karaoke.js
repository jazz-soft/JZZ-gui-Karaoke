!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s:"function"==typeof define&&define.amd?define("JZZ.gui.Karaoke",["JZZ","JZZ.midi.SMF"],s):s(JZZ)}(0,function(d){var r;(d.gui||(d.gui={}),d.gui.Karaoke)||(i.prototype.load=function(e){var s,t,i,n,r,o,h,a,l,p;if(this.gui)for(;this.gui.firstChild;)this.gui.removeChild(this.gui.firstChild);for(this.tracks=[],s=0;s<e.length;s++)if(e[s]instanceof d.MIDI.SMF.MTrk)for(o=void 0,t=0;t<e[s].length;t++)if(1==e[s][t].ff){if(r=e[s][t].tt,o||(o=new v,this.gui&&(o.dom=document.createElement("div"),this.gui.appendChild(o.dom)),this.tracks.push(o),h=void 0),"@"==(i=d.lib.fromUTF8(e[s][t].dd))[0]){(n={K:"k",V:"v",I:"i",L:"l",T:"t",W:"w"}[i[1]])&&(i=i.substring(2)),this.gui&&(l=document.createElement("div"),n&&(l.className=n),l.appendChild(document.createTextNode(i)),o.dom.appendChild(l)),"t"==n&&(o.title=o.title?o.title+"\n"+i:i),h=void 0;continue}"\\"==i[0]?(i=i.substring(1),h=void 0):"/"==i[0]&&(i=i.substring(1),a=void 0),h||(h={tt:r,lines:[]},this.gui&&(h.dom=document.createElement("p"),o.dom.appendChild(h.dom)),o.verses.push(h),a=void 0),a||(a={tt:r,spans:[]},this.gui&&(a.dom=document.createElement("div"),h.dom.appendChild(a.dom)),h.lines.push(a)),p={tt:r,txt:i},this.gui&&(p.dom=document.createElement("span"),p.dom.appendChild(document.createTextNode(i)),a.dom.appendChild(p.dom)),a.spans.push(p)}},i.prototype.reset=function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].reset()},i.prototype._receive=function(e){if(void 0!==e.tt)for(var s=0;s<this.tracks.length;s++)this.tracks[s].update(e.tt)},i.prototype.toString=function(){for(var e=[],s=0;s<this.tracks.length;s++){this.tracks[s];this.tracks[s].title&&(e.length&&e.push(""),e.push(this.tracks[s].title));for(var t=0;t<this.tracks[s].verses.length;t++){e.length&&e.push("");for(var i=0;i<this.tracks[s].verses[t].lines.length;i++){for(var n="",r=0;r<this.tracks[s].verses[t].lines[i].spans.length;r++)n+=this.tracks[s].verses[t].lines[i].spans[r].txt;e.push(n)}}}return e.join("\n")},v.prototype.reset=function(){var e,s,t;if(r)for(e=0;e<this.verses.length;e++)for(this.verses[e].dom.className="",s=0;s<this.verses[e].lines.length;s++)for(this.verses[e].lines[s].dom.className="",t=0;t<this.verses[e].lines[s].spans.length;t++)this.verses[e].lines[s].spans[t].dom.className="";this.verse=void 0},v.prototype.update=function(e){var s;for(s=this.verse?this.verse:0;s<this.verses.length&&!(e<this.verses[s].tt);s++)s!=this.verse&&this.newVerse(s);if(void 0!==this.verse){for(s=this.line?this.line:0;s<this.verses[this.verse].lines.length&&!(e<this.verses[this.verse].lines[s].tt);s++)s!=this.line&&this.newLine(s);for(s=this.span?this.span:0;s<this.verses[this.verse].lines[this.line].spans.length&&!(e<this.verses[this.verse].lines[this.line].spans[s].tt);s++)s!=this.span&&this.newSpan(s)}},v.prototype.oldVerse=function(){if(r){this.verses[this.verse].dom.className="past";for(var e=0;e<this.verses[this.verse].lines.length;e++){this.verses[this.verse].lines[e].dom.className="past";for(var s=0;s<this.verses[this.verse].lines[e].spans.length;s++)this.verses[this.verse].lines[e].spans[s].dom.className="past"}}},v.prototype.newVerse=function(e){e&&this.oldVerse(),r&&(this.verses[e].dom.className="current"),this.verse=e,this.line=void 0},v.prototype.oldLine=function(){if(r){this.verses[this.verse].lines[this.line].dom.className="past";for(var e=0;e<this.verses[this.verse].lines[this.line].spans.length;e++)this.verses[this.verse].lines[this.line].spans[e].dom.className="past"}},v.prototype.newLine=function(e){e&&this.oldLine(),r&&(this.verses[this.verse].lines[e].dom.className="current"),this.line=e,this.span=void 0},v.prototype.oldSpan=function(){r&&(this.verses[this.verse].lines[this.line].spans[this.span].dom.className="past")},v.prototype.newSpan=function(e){var s,t,i,n;e&&this.oldSpan(),r&&(this.verses[this.verse].lines[this.line].spans[e].dom.className="current"),this.span=e,setTimeout((t=(s=this).verse,i=this.line,n=this.span,function(){t==s.verse&&i==s.line&&n==s.span&&(n==s.verses[t].lines[i].spans.length-1?i==s.verses[t].lines.length-1?s.oldVerse():s.oldLine():s.oldSpan())}),1e3)},d.gui.Karaoke=i);function i(e){var s=new d.Widget;for(var t in i.prototype)i.prototype.hasOwnProperty(t)&&(s[t]=i.prototype[t]);s.tracks=[];try{s.gui=document.createElement("div"),r=!0}catch(e){return s}if(s.gui.className="karaoke","string"==typeof e)try{return document.getElementById(e).appendChild(s.gui),s}catch(e){}try{return e.appendChild(s.gui),s}catch(e){}return document.body.appendChild(s.gui),s}function v(){this.verses=[]}});
!function(s,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e:"function"==typeof define&&define.amd?define("JZZ.gui.Karaoke",["JZZ","JZZ.midi.SMF"],e):e(JZZ)}(0,function(d){var o;(d.gui||(d.gui={}),d.gui.Karaoke)||(i.prototype.load=function(s){var e,t,i,r,n,o,h,a,l,p;if(this.gui)for(;this.gui.firstChild;)this.gui.removeChild(this.gui.firstChild);for(this.tracks=[],e=0;e<s.length;e++)if(s[e]instanceof d.MIDI.SMF.MTrk)for(o=void 0,t=0;t<s[e].length;t++)if(1==s[e][t].ff){if(n=s[e][t].tt,o||(o=new v,this.gui&&(o.dom=document.createElement("div"),this.gui.appendChild(o.dom)),this.tracks.push(o),h=void 0),"@"==(i=d.lib.fromUTF8(s[e][t].dd))[0]){(r={K:"k",V:"v",I:"i",L:"l",T:"t",W:"w"}[i[1]])&&(i=i.substring(2)),this.gui&&(l=document.createElement("div"),r&&(l.className=r),l.appendChild(document.createTextNode(i)),o.dom.appendChild(l)),"t"==r&&(o.title=o.title?o.title+"\n"+i:i),h=void 0;continue}"\\"==i[0]?(i=i.substring(1),h=void 0):"/"==i[0]&&(i=i.substring(1),a=void 0),h||(h={tt:n,lines:[]},this.gui&&(h.dom=document.createElement("p"),o.dom.appendChild(h.dom)),o.verses.push(h),a=void 0),a||(a={tt:n,spans:[]},this.gui&&(a.dom=document.createElement("div"),h.dom.appendChild(a.dom)),h.lines.push(a)),p={tt:n,txt:i},this.gui&&(p.dom=document.createElement("span"),p.dom.appendChild(document.createTextNode(i)),a.dom.appendChild(p.dom)),a.spans.push(p)}},i.prototype.reset=function(){for(var s=0;s<this.tracks.length;s++)this.tracks[s].reset()},i.prototype._receive=function(s){if(void 0!==s.tt)for(var e=0;e<this.tracks.length;e++)this.tracks[e].update(s.tt)},i.prototype.toString=function(){for(var s=[],e=0;e<this.tracks.length;e++){this.tracks[e];this.tracks[e].title&&(s.length&&s.push(""),s.push(this.tracks[e].title));for(var t=0;t<this.tracks[e].verses.length;t++){s.length&&s.push("");for(var i=0;i<this.tracks[e].verses[t].lines.length;i++){for(var r="",n=0;n<this.tracks[e].verses[t].lines[i].spans.length;n++)r+=this.tracks[e].verses[t].lines[i].spans[n].txt;s.push(r)}}}return s.join("\n")},v.prototype.reset=function(){var s,e,t;if(o)for(s=0;s<this.verses.length;s++)for(this.verses[s].dom.className="",e=0;e<this.verses[s].lines.length;e++)for(this.verses[s].lines[e].dom.className="",t=0;t<this.verses[s].lines[e].spans.length;t++)this.verses[s].lines[e].spans[t].dom.className="";this.verse=void 0},v.prototype.update=function(s){var e;for(e=this.verse?this.verse:0;e<this.verses.length&&!(s<this.verses[e].tt);e++)e!=this.verse&&this.newVerse(e);if(void 0!==this.verse){for(e=this.line?this.line:0;e<this.verses[this.verse].lines.length&&!(s<this.verses[this.verse].lines[e].tt);e++)e!=this.line&&this.newLine(e);for(e=this.span?this.span:0;e<this.verses[this.verse].lines[this.line].spans.length&&!(s<this.verses[this.verse].lines[this.line].spans[e].tt);e++)e!=this.span&&this.newSpan(e)}},v.prototype.oldVerse=function(){var s,e;if(o)for(this.verses[this.verse].dom.className="past",s=0;s<this.verses[this.verse].lines.length;s++)for(this.verses[this.verse].lines[s].dom.className="past",e=0;e<this.verses[this.verse].lines[s].spans.length;e++)this.verses[this.verse].lines[s].spans[e].dom.className="past";else for(process.stdout.write("\r"),s=0;s<this.verses[this.verse].lines[this.line].spans.length;s++)process.stdout.write(this.verses[this.verse].lines[this.line].spans[s].txt)},v.prototype.newVerse=function(s){s&&this.oldVerse(),o?this.verses[s].dom.className="current":(process.stdout.write("\n"),!s&&this.title&&process.stdout.write(this.title+"\n")),this.verse=s,this.line=void 0},v.prototype.oldLine=function(){var s;if(o)for(this.verses[this.verse].lines[this.line].dom.className="past",s=0;s<this.verses[this.verse].lines[this.line].spans.length;s++)this.verses[this.verse].lines[this.line].spans[s].dom.className="past";else for(process.stdout.write("\r"),s=0;s<this.verses[this.verse].lines[this.line].spans.length;s++)process.stdout.write(this.verses[this.verse].lines[this.line].spans[s].txt)},v.prototype.newLine=function(s){if(s&&this.oldLine(),o)this.verses[this.verse].lines[s].dom.className="current";else{process.stdout.write("\n");for(var e=0;e<this.verses[this.verse].lines[s].spans.length;e++)process.stdout.write(this.verses[this.verse].lines[s].spans[e].txt)}this.line=s,this.span=void 0},v.prototype.oldSpan=function(){o&&(this.verses[this.verse].lines[this.line].spans[this.span].dom.className="past")},v.prototype.newSpan=function(s){if(s&&this.oldSpan(),o)this.verses[this.verse].lines[this.line].spans[s].dom.className="current";else{process.stdout.write("\r[1m");for(var e=0;e<=s;e++)process.stdout.write(this.verses[this.verse].lines[this.line].spans[e].txt);process.stdout.write("[0m")}var t,i,r,n;this.span=s,setTimeout((i=(t=this).verse,r=this.line,n=this.span,function(){i==t.verse&&r==t.line&&n==t.span&&(n==t.verses[i].lines[r].spans.length-1?r==t.verses[i].lines.length-1?t.oldVerse():t.oldLine():t.oldSpan())}),1e3)},d.gui.Karaoke=i);function i(s){var e=new d.Widget;for(var t in i.prototype)i.prototype.hasOwnProperty(t)&&(e[t]=i.prototype[t]);e.tracks=[];try{e.gui=document.createElement("div"),o=!0}catch(s){return e}if(e.gui.className="karaoke","string"==typeof s)try{return document.getElementById(s).appendChild(e.gui),e}catch(s){}try{return s.appendChild(e.gui),e}catch(s){}return document.body.appendChild(e.gui),e}function v(){this.verses=[]}});
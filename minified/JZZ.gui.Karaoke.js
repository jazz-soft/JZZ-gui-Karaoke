!function(s,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e:"function"==typeof define&&define.amd?define("JZZ.gui.Karaoke",["JZZ","JZZ.midi.SMF"],e):e(JZZ)}(0,function(c){var u;(c.gui||(c.gui={}),c.gui.Karaoke)||(((e.prototype=new c.Widget).constructor=e).prototype.load=function(s){var e,t,i,n,r,h,o,a,l,p,d,v=0;if(u)for(;this.gui.firstChild;)this.gui.removeChild(this.gui.firstChild);for(this.tracks=[],e=this._tt=0;e<s.length;e++)if(s[e]instanceof c.MIDI.SMF.MTrk){for(h=void 0,t=d=0;t<s[e].length;t++)if(1==s[e][t].ff){if(r=s[e][t].tt,h||(h=new f,this.track||(this.track=h),u&&(h.dom=document.createElement("div"),this.gui.appendChild(h.dom)),this.tracks.push(h),o=void 0),"@"==(i=c.lib.fromUTF8(s[e][t].dd))[0]){(n={K:"k",V:"v",I:"i",L:"l",T:"t",W:"w"}[i[1]])&&(i=i.substring(2)),u&&(l=document.createElement("div"),n&&(l.className=n),l.appendChild(document.createTextNode(i)),h.dom.appendChild(l)),"t"==n&&(h.title=h.title?h.title+"\n"+i:i),o=void 0;continue}"\\"==i[0]?(i=i.substring(1),o=void 0):"/"==i[0]&&(i=i.substring(1),a=void 0),o||(o={tt:r,lines:[]},u&&(o.dom=document.createElement("p"),h.dom.appendChild(o.dom)),h.verses.push(o),a=void 0),a||(a={tt:r,spans:[]},u&&(a.dom=document.createElement("div"),o.dom.appendChild(a.dom)),o.lines.push(a)),p={tt:r,txt:i},d++,u&&(p.dom=document.createElement("span"),p.dom.appendChild(document.createTextNode(i)),a.dom.appendChild(p.dom)),a.spans.push(p)}h&&v<d&&(v=d,this.track=h)}},e.prototype.reset=function(){for(var s=0;s<this.tracks.length;s++)this.tracks[s].reset()},e.prototype._receive=function(s){void 0!==s.tt&&this.jump(s.tt)},e.prototype.jump=function(s){if(this._tt>s&&this.reset(),this._tt=s,u)for(var e=0;e<this.tracks.length;e++)this.tracks[e].update(s);else this.track&&this.track.update(s)},e.prototype.toString=function(){for(var s=[],e=0;e<this.tracks.length;e++){this.tracks[e];this.tracks[e].title&&(s.length&&s.push(""),s.push(this.tracks[e].title));for(var t=0;t<this.tracks[e].verses.length;t++){s.length&&s.push("");for(var i=0;i<this.tracks[e].verses[t].lines.length;i++){for(var n="",r=0;r<this.tracks[e].verses[t].lines[i].spans.length;r++)n+=this.tracks[e].verses[t].lines[i].spans[r].txt;s.push(n)}}}return s.join("\n")},f.prototype.reset=function(){var s,e,t;if(u)for(s=0;s<this.verses.length;s++)for(this.verses[s].dom.className="",e=0;e<this.verses[s].lines.length;e++)for(this.verses[s].lines[e].dom.className="",t=0;t<this.verses[s].lines[e].spans.length;t++)this.verses[s].lines[e].spans[t].dom.className="";this.verse=void 0},f.prototype.update=function(s){var e;for(e=this.verse?this.verse:0;e<this.verses.length&&!(s<this.verses[e].tt);e++)e!=this.verse&&this.newVerse(e);if(void 0!==this.verse){for(e=this.line?this.line:0;e<this.verses[this.verse].lines.length&&!(s<this.verses[this.verse].lines[e].tt);e++)e!=this.line&&this.newLine(e);for(e=this.span?this.span:0;e<this.verses[this.verse].lines[this.line].spans.length&&!(s<this.verses[this.verse].lines[this.line].spans[e].tt);e++)e!=this.span&&this.newSpan(e)}},f.prototype.oldVerse=function(){var s,e;if(u)for(this.verses[this.verse].dom.className="past",s=0;s<this.verses[this.verse].lines.length;s++)for(this.verses[this.verse].lines[s].dom.className="past",e=0;e<this.verses[this.verse].lines[s].spans.length;e++)this.verses[this.verse].lines[s].spans[e].dom.className="past";else for(process.stdout.write("\r"),s=0;s<this.verses[this.verse].lines[this.line].spans.length;s++)process.stdout.write(this.verses[this.verse].lines[this.line].spans[s].txt)},f.prototype.newVerse=function(s){s&&this.oldVerse(),u?this.verses[s].dom.className="current":(process.stdout.write("\n"),!s&&this.title&&process.stdout.write(this.title+"\n")),this.verse=s,this.line=void 0},f.prototype.oldLine=function(){var s;if(u)for(this.verses[this.verse].lines[this.line].dom.className="past",s=0;s<this.verses[this.verse].lines[this.line].spans.length;s++)this.verses[this.verse].lines[this.line].spans[s].dom.className="past";else for(process.stdout.write("\r"),s=0;s<this.verses[this.verse].lines[this.line].spans.length;s++)process.stdout.write(this.verses[this.verse].lines[this.line].spans[s].txt)},f.prototype.newLine=function(s){if(s&&this.oldLine(),u)this.verses[this.verse].lines[s].dom.className="current";else{process.stdout.write("\n");for(var e=0;e<this.verses[this.verse].lines[s].spans.length;e++)process.stdout.write(this.verses[this.verse].lines[s].spans[e].txt)}this.line=s,this.span=void 0},f.prototype.oldSpan=function(){u&&(this.verses[this.verse].lines[this.line].spans[this.span].dom.className="past")},f.prototype.newSpan=function(s){if(s&&this.oldSpan(),u)this.verses[this.verse].lines[this.line].spans[s].dom.className="current";else{process.stdout.write("\r[1m");for(var e=0;e<=s;e++)process.stdout.write(this.verses[this.verse].lines[this.line].spans[e].txt);process.stdout.write("[0m")}var t,i,n,r;this.span=s,setTimeout((i=(t=this).verse,n=this.line,r=this.span,function(){i==t.verse&&n==t.line&&r==t.span&&(r==t.verses[i].lines[n].spans.length-1?n==t.verses[i].lines.length-1?t.oldVerse():t.oldLine():t.oldSpan())}),1e3)},c.gui.Karaoke=e);function e(s){if(!(this instanceof e))return new e(s);this.tracks=[];try{this.gui=document.createElement("div"),u=!0}catch(s){return this}if(this.gui.className="karaoke","string"==typeof s)try{return document.getElementById(s).appendChild(this.gui),this}catch(s){}try{return s.appendChild(this.gui),this}catch(s){}document.body.appendChild(this.gui)}function f(){this.verses=[]}});
!function(s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s:"function"==typeof define&&define.amd?define("JZZ.gui.Karaoke",["JZZ","JZZ.midi.SMF"],s):s(JZZ)}(function(d){var v;function e(s){if(!(this instanceof e))return new e(s);this.tracks=[];try{this.gui=document.createElement("div"),v=!0}catch(s){return this}if(this.gui.className="karaoke","string"==typeof s)try{return document.getElementById(s).appendChild(this.gui),this}catch(s){}try{return s.appendChild(this.gui),this}catch(s){}document.body.appendChild(this.gui)}function c(){this.verses=[]}d.gui||(d.gui={}),d.gui.Karaoke||(((e.prototype=new d.Widget).constructor=e).prototype.load=function(s){var e,t,i,n,r,o,h,a,l,p=0;if(v)for(;this.gui.firstChild;)this.gui.removeChild(this.gui.firstChild);for(this.tracks=[],e=this._tt=0;e<s.length;e++)if(s[e]instanceof d.MIDI.SMF.MTrk){for(r=void 0,t=l=0;t<s[e].length;t++)1==s[e][t].ff&&(n=s[e][t].tt,r||(r=new c,this.track||(this.track=r),v&&(r.dom=document.createElement("div"),this.gui.appendChild(r.dom)),this.tracks.push(r),o=void 0),"@"!=(i=d.lib.fromUTF8(s[e][t].dd))[0]?("\\"==i[0]?(i=i.substring(1),o=void 0):"/"==i[0]&&(i=i.substring(1),h=void 0),o||(o={tt:n,lines:[]},v&&(o.dom=document.createElement("p"),r.dom.appendChild(o.dom)),r.verses.push(o),h=void 0),h||(h={tt:n,spans:[]},v&&(h.dom=document.createElement("div"),o.dom.appendChild(h.dom)),o.lines.push(h)),a={tt:n,txt:i},l++,v&&(a.dom=document.createElement("span"),a.dom.appendChild(document.createTextNode(i)),h.dom.appendChild(a.dom)),h.spans.push(a)):((n={K:"k",V:"v",I:"i",L:"l",T:"t",W:"w"}[i[1]])&&(i=i.substring(2)),v&&(a=document.createElement("div"),n&&(a.className=n),a.appendChild(document.createTextNode(i)),r.dom.appendChild(a)),"t"==n&&(r.title=r.title?r.title+"\n"+i:i),o=void 0));r&&p<l&&(p=l,this.track=r)}},e.prototype.reset=function(){for(var s=0;s<this.tracks.length;s++)this.tracks[s].reset()},e.prototype._receive=function(s){void 0!==s.tt&&this.jump(s.tt)},e.prototype.jump=function(s){if(this._tt>s&&this.reset(),this._tt=s,v)for(var e=0;e<this.tracks.length;e++)this.tracks[e].update(s);else this.track&&this.track.update(s)},e.prototype.toString=function(){for(var s=[],e=0;e<this.tracks.length;e++){var t=this.tracks[e];t.title&&(s.length&&s.push(""),s.push(t.title));for(var i=0;i<t.verses.length;i++){s.length&&s.push("");for(var n=0;n<t.verses[i].lines.length;n++){for(var r="",o=0;o<t.verses[i].lines[n].spans.length;o++)r+=t.verses[i].lines[n].spans[o].txt;s.push(r)}}}return s.join("\n")},c.prototype.reset=function(){var s,e,t;if(v)for(s=0;s<this.verses.length;s++)for(this.verses[s].dom.className="",e=0;e<this.verses[s].lines.length;e++)for(this.verses[s].lines[e].dom.className="",t=0;t<this.verses[s].lines[e].spans.length;t++)this.verses[s].lines[e].spans[t].dom.className="";this.verse=void 0},c.prototype.update=function(s){for(var e=this.verse||0;e<this.verses.length&&!(s<this.verses[e].tt);e++)e!=this.verse&&this.newVerse(e);if(void 0!==this.verse){for(e=this.line||0;e<this.verses[this.verse].lines.length&&!(s<this.verses[this.verse].lines[e].tt);e++)e!=this.line&&this.newLine(e);for(e=this.span||0;e<this.verses[this.verse].lines[this.line].spans.length&&!(s<this.verses[this.verse].lines[this.line].spans[e].tt);e++)e!=this.span&&this.newSpan(e)}},c.prototype.oldVerse=function(){var s,e;if(v)for(this.verses[this.verse].dom.className="past",s=0;s<this.verses[this.verse].lines.length;s++)for(this.verses[this.verse].lines[s].dom.className="past",e=0;e<this.verses[this.verse].lines[s].spans.length;e++)this.verses[this.verse].lines[s].spans[e].dom.className="past";else for(process.stdout.write("\r"),s=0;s<this.verses[this.verse].lines[this.line].spans.length;s++)process.stdout.write(this.verses[this.verse].lines[this.line].spans[s].txt)},c.prototype.newVerse=function(s){s&&this.oldVerse(),v?this.verses[s].dom.className="current":(process.stdout.write("\n"),!s&&this.title&&process.stdout.write(this.title+"\n")),this.verse=s,this.line=void 0},c.prototype.oldLine=function(){var s;if(v)for(this.verses[this.verse].lines[this.line].dom.className="past",s=0;s<this.verses[this.verse].lines[this.line].spans.length;s++)this.verses[this.verse].lines[this.line].spans[s].dom.className="past";else for(process.stdout.write("\r"),s=0;s<this.verses[this.verse].lines[this.line].spans.length;s++)process.stdout.write(this.verses[this.verse].lines[this.line].spans[s].txt)},c.prototype.newLine=function(s){if(s&&this.oldLine(),v)this.verses[this.verse].lines[s].dom.className="current";else{process.stdout.write("\n");for(var e=0;e<this.verses[this.verse].lines[s].spans.length;e++)process.stdout.write(this.verses[this.verse].lines[s].spans[e].txt)}this.line=s,this.span=void 0},c.prototype.oldSpan=function(){v&&(this.verses[this.verse].lines[this.line].spans[this.span].dom.className="past")},c.prototype.newSpan=function(s){if(s&&this.oldSpan(),v)this.verses[this.verse].lines[this.line].spans[s].dom.className="current";else{process.stdout.write("\r[1m");for(var e=0;e<=s;e++)process.stdout.write(this.verses[this.verse].lines[this.line].spans[e].txt);process.stdout.write("[0m")}var t,i,n,r;this.span=s,setTimeout((i=(t=this).verse,n=this.line,r=this.span,function(){i==t.verse&&n==t.line&&r==t.span&&(r==t.verses[i].lines[n].spans.length-1?n==t.verses[i].lines.length-1?t.oldVerse():t.oldLine():t.oldSpan())}),1e3)},d.gui.Karaoke=e)});
!function(s,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e:"function"==typeof define&&define.amd?define("JZZ.gui.Karaoke",["JZZ","JZZ.midi.SMF"],e):e(JZZ)}(0,function(v){var i;(v.gui||(v.gui={}),v.gui.Karaoke)||(n.prototype.load=function(s){var e,t,i,n,r,h,a,o,l,d;if(this.gui)for(;this.gui.firstChild;)this.gui.removeChild(this.gui.firstChild);for(this.tracks=[],e=0;e<s.length;e++)if(s[e]instanceof v.MIDI.SMF.MTrk)for(h=void 0,t=0;t<s[e].length;t++)if(1==s[e][t].ff){if(r=s[e][t].tt,h||(h={tt:r,verses:[],reset:p,update:c,newVerse:u,newLine:m,newSpan:f},this.gui&&(h.dom=document.createElement("div"),this.gui.appendChild(h.dom)),this.tracks.push(h),a=void 0),"@"==(i=v.lib.fromUTF8(s[e][t].dd))[0]){(n={K:"k",V:"v",I:"i",L:"l",T:"t",W:"w"}[i[1]])&&(i=i.substring(2)),this.gui&&(l=document.createElement("div"),n&&(l.className=n),l.appendChild(document.createTextNode(i)),h.dom.appendChild(l)),"t"==n&&(h.title=h.title?h.title+"\n"+i:i),a=void 0;continue}"\\"==i[0]?(i=i.substring(1),a=void 0):"/"==i[0]&&(i=i.substring(1),o=void 0),a||(a={tt:r,lines:[]},this.gui&&(a.dom=document.createElement("p"),h.dom.appendChild(a.dom)),h.verses.push(a),o=void 0),o||(o={tt:r,spans:[]},this.gui&&(o.dom=document.createElement("div"),a.dom.appendChild(o.dom)),a.lines.push(o)),d={tt:r,txt:i},this.gui&&(d.dom=document.createElement("span"),d.dom.appendChild(document.createTextNode(i)),o.dom.appendChild(d.dom)),o.spans.push(d)}},n.prototype.reset=function(){for(var s=0;s<this.tracks.length;s++)this.tracks[s].reset()},n.prototype._receive=function(s){if(void 0!==s.tt)for(var e=0;e<this.tracks.length;e++)this.tracks[e].update(s.tt)},n.prototype.toString=function(){for(var s=[],e=0;e<this.tracks.length;e++){this.tracks[e];this.tracks[e].title&&(s.length&&s.push(""),s.push(this.tracks[e].title));for(var t=0;t<this.tracks[e].verses.length;t++){s.length&&s.push("");for(var i=0;i<this.tracks[e].verses[t].lines.length;i++){for(var n="",r=0;r<this.tracks[e].verses[t].lines[i].spans.length;r++)n+=this.tracks[e].verses[t].lines[i].spans[r].txt;s.push(n)}}}return s.join("\n")},v.gui.Karaoke=n);function n(s){var e=new v.Widget;for(var t in n.prototype)n.prototype.hasOwnProperty(t)&&(e[t]=n.prototype[t]);e.tracks=[];try{e.gui=document.createElement("div"),i=!0}catch(s){return e}if(e.gui.className="karaoke","string"==typeof s)try{return document.getElementById(s).appendChild(e.gui),e}catch(s){}try{return s.appendChild(e.gui),e}catch(s){}return document.body.appendChild(e.gui),e}function p(){var s,e,t;if(i)for(s=0;s<this.verses.length;s++)for(this.verses[s].dom.className="",e=0;e<this.verses[s].lines.length;e++)for(this.verses[s].lines[e].dom.className="",t=0;t<this.verses[s].lines[e].spans.length;t++)this.verses[s].lines[e].spans[t].dom.className="";this.verse=void 0}function c(s){var e;for(e=this.verse?this.verse:0;e<this.verses.length&&!(s<this.verses[e].tt);e++)e!=this.verse&&this.newVerse(e);if(void 0!==this.verse){for(e=this.line?this.line:0;e<this.verses[this.verse].lines.length&&!(s<this.verses[this.verse].lines[e].tt);e++)e!=this.line&&this.newLine(e);for(e=this.span?this.span:0;e<this.verses[this.verse].lines[this.line].spans.length&&!(s<this.verses[this.verse].lines[this.line].spans[e].tt);e++)e!=this.span&&this.newSpan(e)}}function u(s){if(i){if(s){this.verses[this.verse].dom.className="past";for(var e=0;e<this.verses[this.verse].lines.length;e++){this.verses[this.verse].lines[e].dom.className="past";for(var t=0;t<this.verses[this.verse].lines[e].spans.length;t++)this.verses[this.verse].lines[e].spans[t].dom.className="past"}}this.verses[s].dom.className="current"}this.verse=s,this.line=void 0}function m(s){if(i){if(s){this.verses[this.verse].lines[this.line].dom.className="past";for(var e=0;e<this.verses[this.verse].lines[this.line].spans.length;e++)this.verses[this.verse].lines[this.line].spans[e].dom.className="past"}this.verses[this.verse].lines[s].dom.className="current"}this.line=s,this.span=void 0}function f(s){i&&(s&&(this.verses[this.verse].lines[this.line].spans[this.span].dom.className="past"),this.verses[this.verse].lines[this.line].spans[s].dom.className="current"),this.span=s}});